/**
 * @fileoverview Firestore Security Rules for Savings Tracker App
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for savings entries. Each user can only access their own data.
 *
 * Data Structure:
 * All savings entries are nested under /users/{userId}/savingsEntries/{savingsEntryId}.
 *
 * Key Security Decisions:
 * - Users can only manage (create, read, update, delete) savings entries associated with their own user ID.
 * - Listing all users is disallowed for privacy and security.
 *
 * Denormalization for Authorization:
 *  - The `userId` is embedded in the path (`/users/{userId}/...`), enabling path-based authorization without needing to read the document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages individual savings entries for each user.
     * @path /users/{userId}/savingsEntries/{savingsEntryId}
     * @allow (create) - User 'user123' can create a new savings entry under their user ID.
     *    Request: { "auth": { "uid": "user123" }, "resource.data": { "id": "user123", "amount": 100, "currency": "USD", "usdAmount": 100, "entryDate": "2024-01-01T00:00:00Z" } }
     * @allow (get) - User 'user123' can retrieve their savings entry.
     *    Request: { "auth": { "uid": "user123" } }
     * @allow (update) - User 'user123' can update their existing savings entry.
     *    Request: { "auth": { "uid": "user123" }, "resource.data": { "id": "user123", "amount": 120, "currency": "USD", "usdAmount": 120, "entryDate": "2024-01-02T00:00:00Z" } }
     * @allow (delete) - User 'user123' can delete their savings entry.
     *    Request: { "auth": { "uid": "user123" } }
     * @deny (create) - User 'user456' cannot create a savings entry under 'user123's ID.
     *    Request: { "auth": { "uid": "user456" }, "resource.data": { "id": "user123", "amount": 100 } }
     * @deny (get) - User 'user456' cannot retrieve 'user123's savings entry.
     *    Request: { "auth": { "uid": "user456" } }
     * @deny (update) - User 'user456' cannot update 'user123's savings entry.
     *    Request: { "auth": { "uid": "user456" }, "resource.data": { "id": "user123", "amount": 120 } }
     * @deny (delete) - User 'user456' cannot delete 'user123's savings entry.
     *    Request: { "auth": { "uid": "user456" } }
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/savingsEntries/{savingsEntryId} {
      // Helper function to check if the user is signed in.
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the requesting user is the owner of the document.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the requesting user is the owner of the existing document.
      function isExistingOwner(userId) {
        return isOwner(userId) && existsAfter(/databases/$(database)/documents/users/$(userId)/savingsEntries/$(savingsEntryId));
      }

      // Allow reading data if the user is the owner.
      allow get: if isOwner(userId);

      // Allow listing data if the user is the owner.
      allow list: if isOwner(userId);

      // Allow creating data if the user is the owner.
      allow create: if isOwner(userId);

      // Allow updating data if the user is the owner.
      allow update: if isExistingOwner(userId);

      // Allow deleting data if the user is the owner.
      allow delete: if isExistingOwner(userId);
    }
  }
}