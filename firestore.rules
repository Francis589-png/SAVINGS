/**
 * @file Firebase Security Rules for the Savings Tracker App.
 *
 * @corePhilosophy This ruleset enforces a strict user-ownership model, ensuring that only the authenticated user can access their own savings data.
 * @dataStructure All savings entries are stored under the `/users/{userId}/savingsEntries/{savingsEntryId}` path, providing a clear hierarchical structure.
 * @keySecurityDecisions
 *   - Users can only access their own data; cross-user access is strictly forbidden.
 *   - The rules explicitly deny any attempt to list all users or all savings entries across users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces user-ownership for savings entries. Only the user with the matching UID can create, read, update, or delete their own savings entries.
     * @path /users/{userId}/savingsEntries/{savingsEntryId}
     * @allow (create) - User 'AFQe994W3qWfSMx8abcoF2rcTq92' can create a savings entry with id 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123 if authenticated.
     * @allow (get) - User 'AFQe994W3qWfSMx8abcoF2rcTq92' can retrieve savings entry 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123 if authenticated.
     * @allow (update) - User 'AFQe994W3qWfSMx8abcoF2rcTq92' can update savings entry 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123 if authenticated and the document exists.
     * @allow (delete) - User 'AFQe994W3qWfSMx8abcoF2rcTq92' can delete savings entry 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123 if authenticated and the document exists.
     * @deny (create) - User 'randomUser' cannot create a savings entry under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123.
     * @deny (get) - User 'randomUser' cannot retrieve savings entry 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123.
     * @deny (update) - User 'randomUser' cannot update savings entry 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123.
     * @deny (delete) - User 'randomUser' cannot delete savings entry 'entry123' under /users/AFQe994W3qWfSMx8abcoF2rcTq92/savingsEntries/entry123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/savingsEntries/{savingsEntryId} {
      // Helper function to check if the request is made by the owner of the document.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the request is made by the owner of the existing document.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow reads (get) by the owner.
      allow get: if isOwner(userId);

      // Allow listing savings entries for the owner.
      allow list: if isOwner(userId);

      // Allow creation of savings entries by the owner.
      allow create: if isOwner(userId);

      // Allow updates by the owner if the document exists
      allow update: if isExistingOwner(userId);

      // Allow deletes by the owner if the document exists.
      allow delete: if isExistingOwner(userId);
    }

      /**
       * @description Grants read access to a user's "notes/main" document.
       * @path /users/{userId}/notes/main
       * @allow (get) User 'AFQe994W3qWfSMx8abcoF2rcTq92' can get the 'main' document from their notes
       * @deny (get) User 'anotherUserId' cannot get the 'main' document from user 'AFQe994W3qWfSMx8abcoF2rcTq92's notes.
       */
      match /users/{userId}/notes/main {
          function isOwner(userId) {
            return request.auth != null && request.auth.uid == userId;
          }

          allow get: if isOwner(userId);
          allow create: if false;
          allow update: if false;
          allow delete: if false;
          allow list: if false;
      }
  }
}