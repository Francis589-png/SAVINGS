/**
 * @description This ruleset enforces a strict user-ownership model for savings entries.
 * All data is nested under /users/{userId}/savingsEntries/{savingsEntryId}, ensuring
 * that each user can only access their own savings data.
 *
 * @dataStructure
 * - /users/{userId}/savingsEntries/{savingsEntryId}: Stores individual savings entries.
 *
 * @keySecurityDecisions
 * - Disallows listing all users.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * @denormalizationForAuthorization
 * - The rules leverage path-based authorization, eliminating the need for data denormalization. The `userId` is obtained directly from the path.
 *
 * @structuralSegregation
 * - There is no public data in this model. All savings entries are private to the user.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to individual savings entries for each user.
     * @path /users/{userId}/savingsEntries/{savingsEntryId}
     * @allow (create) - Authenticated user 'yB6n7HmoroWOtETG4s5W4oSbbev1' can create a savings entry under their own user ID.
     * @allow (get) - Authenticated user 'yB6n7HmoroWOtETG4s5W4oSbbev1' can retrieve their own savings entry.
     * @allow (update) - Authenticated user 'yB6n7HmoroWOtETG4s5W4oSbbev1' can update their own savings entry.
     * @allow (delete) - Authenticated user 'yB6n7HmoroWOtETG4s5W4oSbbev1' can delete their own savings entry.
     * @deny (create) - Authenticated user 'anotherUser' cannot create a savings entry under user ID 'yB6n7HmoroWOtETG4s5W4oSbbev1'.
     * @deny (get) - Authenticated user 'anotherUser' cannot retrieve savings entries under user ID 'yB6n7HmoroWOtETG4s5W4oSbbev1'.
     * @deny (update) - Authenticated user 'anotherUser' cannot update savings entries under user ID 'yB6n7HmoroWOtETG4s5W4oSbbev1'.
     * @deny (delete) - Authenticated user 'anotherUser' cannot delete savings entries under user ID 'yB6n7HmoroWOtETG4s5W4oSbbev1'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/savingsEntries/{savingsEntryId} {
      // Helper function to check if the current user is the owner of the document.
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Helper function to check if the current user is the owner of the document AND the document exists.
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Allow the owner to read their own savings entry
      allow get: if isOwner(userId);

      // Allow the owner to list their own savings entries
      allow list: if isOwner(userId);

      // Allow the owner to create a new savings entry
      allow create: if isOwner(userId);

      // Allow the owner to update their own savings entry, but enforce immutability of the userId field.
      allow update: if isExistingOwner(userId);

      // Allow the owner to delete their own savings entry
      allow delete: if isExistingOwner(userId);
    }
  }
}